CREATE SCHEMA IF NOT EXISTS UDFs;

-- Create a function to calculate annual tax of employees

CREATE OR REPLACE FUNCTION EMP.UDFS.UDF_CAL_ANNUAL_TAX(MON_GROS_SAL INTEGER)
RETURNS NUMBER
LANGUAGE SQL
AS
$$
    SELECT CAST(
        CASE WHEN (MON_GROS_SAL * 12 <= 500000) THEN 0
                WHEN ((MON_GROS_SAL * 12) BETWEEN 500001 AND 1000000)
                    THEN ((MON_GROS_SAL * 12) - 500000) * 10/100
                WHEN ((MON_GROS_SAL * 12) BETWEEN 1000001 AND 1500000)
                    THEN ((1000000 - 500000) * 10/100) + (((MON_GROS_SAL * 12) - 1000000) * 20/100)
                ELSE
                    ((1000000 - 500000) * 10/100) + ((1500000 - 1000000) * 20/100) + (((MON_GROS_SAL * 12) - 1500000) * 30/100)
    END
    AS NUMBER(10,2))

$$;

UPDATE EMP.HRDATA.EMPLOYEES SET SALARY = SALARY * 10;

SELECT EMPLOYEE_ID,FIRST_NAME, LAST_NAME, SALARY, EMP.UDFS.UDF_CAL_ANNUAL_TAX(SALARY) AS ANNUAL_TAX FROM EMP.HRDATA.EMPLOYEES;


-- Calculate the Annual Tax based on the New Regime

CREATE OR REPLACE FUNCTION EMP.UDFS.UDF_TAX_CAL_NEW_REGIME(TOTAL_INCOME NUMBER(20,2), HOME_LOAN_INT NUMBER(20,2), OTHER_DED NUMBER(20,2))
RETURNS FLOAT
LANGUAGE SQL
AS
$$


    -- here 50000 is standard deduction

    WITH TA AS
        (SELECT TOTAL_INCOME - (50000 + HOME_LOAN_INT + OTHER_DED) AS TAXABLE_AMOUNT),

    TAX AS 
        ( SELECT
        CASE WHEN (TA.TAXABLE_AMOUNT <= 300000)
                THEN 0
            WHEN (TA.TAXABLE_AMOUNT BETWEEN 300001 AND 600000)
                THEN (TA.TAXABLE_AMOUNT - 300000) * (5/100)
            WHEN (TA.TAXABLE_AMOUNT BETWEEN 600001 AND 900000)
                THEN ((600000 - 300000) * (5/100)) + ((TA.TAXABLE_AMOUNT - 600000) * (10/100))
            WHEN (TA.TAXABLE_AMOUNT BETWEEN 900001 AND 1200000)
                THEN ((600000 - 900000) * (5/100)) + ((900000 - 600000) * (10/100)) + ((TA.TAXABLE_AMOUNT - 900000) * (15/100))
            WHEN (TA.TAXABLE_AMOUNT BETWEEN 1200000 AND 1500000)
                THEN ((600000 - 300000) * (5/100)) + ((900000 - 600000) * (10/100)) + ((120000 - 900000) * (15/100)) + ((TA.TAXABLE_AMOUNT - 1200000) * (20/100))
            ELSE ((600000 - 300000) * (5/100)) + ((900000 - 600000) * (10/100)) + ((120000 - 900000) * (15/100)) + ((15000000 - 1200000) * (20/100)) + ((TA.TAXABLE_AMOUNT - 1500000) * (30/100))
    END AS TAX_AMT
    FROM TA
        )
    SELECT CAST(TAX_AMT AS FLOAT) FROM TAX

$$ ;


SELECT EMP.UDFS.UDF_TAX_CAL_NEW_REGIME(800209, 100000,20000) AS TAX;