-- create a function to get the manager names of all employees
CREATE OR REPLACE FUNCTION EMP.UDFS.UDF_MANAGER_DETAILS()
RETURNS TABLE(EMP_NAME VARCHAR, MANAGER_NAME VARCHAR)
LANGUAGE SQL
AS
$$
    SELECT EMPL.FIRST_NAME||' '||EMPL.LAST_NAME AS EMP_NAME, MGR.FIRST_NAME||' '||MGR.LAST_NAME AS MANAGER_NAME
    FROM EMP.HRDATA.EMPLOYEES EMPL
    JOIN EMP.HRDATA.EMPLOYEES MGR
    ON EMPL.MANAGER_ID = MGR.MANAGER_ID
$$;

SELECT EMP_NAME, MANAGER_NAME FROM TABLE(UDF_MANAGER_DETAILS());


-- create a function to get manager and his direct reporteess

CREATE OR REPLACE FUNCTION EMP.UDFS.UDF_DIRECT_REPORTEES()
RETURNS TABLE(MANAGER_NAME VARCHAR, DIRECT_REPORTEES VARCHAR)
LANGUAGE SQL
AS
$$
    SELECT MANAGER_NAME, LISTAGG(EMP_NAME, ', ') FROM 
    (
        SELECT EMPL.FIRST_NAME||' '||EMPL.LAST_NAME AS EMP_NAME, MGR.FIRST_NAME||' '||MGR.LAST_NAME AS MANAGER_NAME
        FROM EMP.HRDATA.EMPLOYEES EMPL
        JOIN EMP.HRDATA.EMPLOYEES MGR
        ON EMPL.MANAGER_ID = MGR.MANAGER_ID
    ) ABC
    GROUP BY MANAGER_NAME
$$;

SELECT MANAGER_NAME, DIRECT_REPORTEES FROM TABLE(UDF_DIRECT_REPORTEES());