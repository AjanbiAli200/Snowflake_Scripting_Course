-- Find the total salary of Sales Department

EXECUTE IMMEDIATE
$$
DECLARE
    C1 CURSOR FOR SELECT d.department_name, e.salary FROM EMP.HRDATA.EMPLOYEES e
                    JOIN EMP.HRDATA.DEPARTMENTS d ON e.dept_id = d.dept_id
                    WHERE UPPER(d.department_name) = 'SALES';
    DNAME VARCHAR;
    SAL INTEGER;
    TOT_SAL INTEGER DEFAULT 0;

BEGIN
FOR REC IN C1 DO
    DNAME := REC.department_name;
    SAL := REC.salary;
    TOT_SAL := TOT_SAL + SAL;
END FOR;

RETURN 'TOTAL SALARY OF ' || DNAME || ' is: '|| TOT_SAL;
END;
$$;



-- FIND TOTAL SALARY OF GIVEN DEPARTMENT

CREATE OR REPLACE PROCEDURE EMP.PROCS.SP_CUR_TOTAL_SALARY("DEPT" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS
DECLARE
    C1 CURSOR FOR SELECT D.DEPARTMENT_NAME, E.SALARY FROM EMP.HRDATA.EMPLOYEES E
                    JOIN EMP.HRDATA.DEPARTMENTS D ON E.DEPT_ID = D.DEPT_ID
                    WHERE UPPER(DEPARTMENT_NAME) = UPPER(?);
    DNAME VARCHAR;
    SAL INTEGER;
    TOT_SAL INTEGER DEFAULT 0;

BEGIN

OPEN C1 USING(:DEPT);

FOR REC IN C1 DO
    DNAME := REC.DEPARTMENT_NAME;
    SAL := REC.SALARY;
    TOT_SAL := TOT_SAL + SAL;
END FOR;

CLOSE C1;



RETURN 'TOTAL SALARY OF ' || DNAME || ' is: ' || TOT_SAL;
END;


CALL EMP.PROCS.SP_CUR_TOTAL_SALARY('SALES');

CALL EMP.PROCS.SP_CUR_TOTAL_SALARY('IT');



-- FIND TOP N SALARIED PERSON OF GIVEN DEPARTMENT

CREATE OR REPLACE PROCEDURE EMP.PROCS.SP_RS_TOP_N_SALARIED("DEPT" VARCHAR, "N" INTEGER)
RETURNS TABLE(VARCHAR, INTEGER)
LANGUAGE SQL
EXECUTE AS CALLER
AS
DECLARE
    RES RESULTSET;
    QUERY VARCHAR;
BEGIN
    QUERY := 'SELECT FIRST_NAME || '' ''|| LAST_NAME AS EMP_NAME, SALARY FROM
                (SELECT E.FIRST_NAME, E.LAST_NAME, E.SALARY, DENSE_RANK() OVER(PARTITION BY E.DEPT_ID ORDER BY SALARY DESC) AS RANK 
                FROM EMP.HRDATA.EMPLOYEES E JOIN EMP.HRDATA.DEPARTMENTS D
                ON E.DEPT_ID = D.DEPT_ID
                WHERE UPPER(DEPARTMENT_NAME) = UPPER('''||:DEPT||''')
                ) ABC WHERE RANK <= '||:N;
RES := (EXECUTE IMMEDIATE :QUERY);

RETURN TABLE(RES);
END;

CALL EMP.PROCS.SP_RS_TOP_N_SALARIED('SALES',4);

CALL EMP.PROCS.SP_RS_TOP_N_SALARIED('IT',3);

CALL EMP.PROCS.SP_RS_TOP_N_SALARIED('MArketING', 5);