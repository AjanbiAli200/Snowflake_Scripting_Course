CREATE OR REPLACE PROCEDURE TEST_EMP.PROCS.SP_MIGRATE_VIEWS("SRCDB" VARCHAR, "SRCSCHEMA" VARCHAR, "TGTDB" VARCHAR, "TGTSCHEMA" VARCHAR, "ALL_FLAG" VARCHAR(1))
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS
DECLARE

-- ALL FLAG - 'Y' IF YOU WANT TO MIGRATE ALL THE TABLES FROM THE SCHEMA, 'N' IF YOU WANT TO MIGRATE SPECIFIC TABLES

CUR_ALL_VIEWS CURSOR FOR SELECT DISTINCT TABLE_NAME AS VIEW_NAME FROM TABLE(?) WHERE TABLE_SCHEMA = ? AND TABLE_TYPE = 'VIEW';
CUR_SOME_VIEWS CURSOR FOR SELECT DISTINCT VIEW_NAME FROM TABLE(?);
CUR_ENV CURSOR FOR SELECT SRC_ENV_DB, TGT_ENV_DB FROM TABLE(?);

SRCVIEW VARCHAR;
DDL_STATEMENT VARCHAR;

BEGIN

    IF (:ALL_FLAG = 'Y') THEN
        OPEN CUR_ALL_VIEWS USING(:SRCDB||'.INFORMATION_SCHEMA.TABLES', :SRCSCHEMA);

        FOR REC IN CUR_ALL_VIEWS DO
            SRCVIEW := REC.VIEW_NAME;
            SELECT GET_DDL('VIEW', :SRCDB||'.'||:SRCSCHEMA||'.'||:SRCVIEW) INTO :DDL_STATEMENT;

            -- REPLACE THE DATABASES IN THE VIEW DEFINITION
            OPEN CUR_ENV USING(:TGTDB||'.WORK.XW_ENV_DATABASES');
            FOR REC1 IN CUR_ENV DO
                DDL_STATEMENT := REGEXP_REPLACE(:DDL_STATEMENT, REC1.SRC_ENV_DB, REC1.TGT_ENV_DB, 1, 0, 'i');
            END FOR;
            CLOSE CUR_ENV;

            DDL_STATEMENT := REGEXP_REPLACE(:DDL_STATEMENT, 'create or replace view ', 'create or replace view '||:TGTDB||'.'||:TGTSCHEMA||'.', 1, 0, 'i');
            
            EXECUTE IMMEDIATE :DDL_STATEMENT;

        END FOR;

        CLOSE CUR_ALL_VIEWS;

    ELSE

        OPEN CUR_SOME_VIEWS USING (:TGTDB||'.WORK.MIGRATE_VIEWS');

        FOR REC IN CUR_SOME_VIEWS DO

            SRCVIEW := REC.VIEW_NAME;
            SELECT GET_DDL('VIEW', :SRCDB||'.'||:SRCSCHEMA||'.'||:SRCVIEW) INTO :DDL_STATEMENT;

            OPEN CUR_ENV USING (:TGTDB||'.WORK.XW_ENV_DATABASES');
            FOR REC1 IN CUR_ENV DO
                DDL_STATEMENT := REGEXP_REPLACE(:DDL_STATEMENT, REC1.SRC_ENV_DB, REC1.TGT_ENV_DB, 1, 0, 'i');
            END FOR;
            CLOSE CUR_ENV;

            DDL_STATEMENT := REGEXP_REPLACE(:DDL_STATEMENT, 'create or replace view ', 'create or replace view '||:TGTDB||'.'||:TGTSCHEMA||'.', 1, 0, 'i');

            EXECUTE IMMEDIATE :DDL_STATEMENT;

        END FOR;

        CLOSE CUR_SOME_VIEWS;

    END IF;

    RETURN 'VIEWS MIGRATED SUCCESSFULLY';

END;



INSERT INTO TEST_EMP.WORK.MIGRATE_VIEWS VALUES('V_COUNTRIES'), ('V_DEPT_WISE_EMP_HIRED'), ('V_EMPLOYEE_DETAILS');


CALL TEST_EMP.PROCS.SP_MIGRATE_VIEWS('DEV_EMP', 'HRDATA', 'TEST_EMP', 'HRDATA', 'N');

CALL TEST_EMP.PROCS.SP_MIGRATE_VIEWS('DEV_EMP','HRDATA','TEST_EMP', 'HRDATA', 'Y');


CALL DEV_EMP.PROCS.SP_AUTOMATE_VIEW_CREATION('DEV_EMP', 'HRDATA');

                